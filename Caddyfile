# Snippets
(no_robots) {
    header X-Robots-Tag "none"
}

{$SITE_ADDRESS} {

    # Security Headers
    header {
        # Force HTTPS (HSTS)
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        # Prevent MIME-sniffing
        X-Content-Type-Options "nosniff"
        # Protect against Clickjacking (allow same origin)
        X-Frame-Options "SAMEORIGIN"
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Remove Server header for obscurity
        -Server
    }

    # Compression for performance
    encode zstd gzip

    # 1. API
    handle_path /api/* {
        import no_robots
        reverse_proxy api:8000
    }

    # 2. Maputnik style editor
    # Route /editor/* with path stripping
    handle_path /editor/* {
        import no_robots
        reverse_proxy maputnik:8000
    }
    # Route Maputnik assets (absolute paths in the HTML)
    @maputnik_assets {
        path /assets/* /manifest*.json /favicon*.ico
    }
    handle @maputnik_assets {
        reverse_proxy maputnik:8000
    }

    # 3. Documentation
    handle /docs/* {
        reverse_proxy docs:3000
    }

    # 4. Front-end

    handle {
        reverse_proxy frontend:5173
    }

    # Error handling
    handle_errors {
        respond "{err.status_code} {err.status_text}"
    }
}